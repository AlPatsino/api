# Описание API загрузки подразделений

API предназначено для обновления иерархии подразделений.

Включает два метода: загрузка новой иерархии и метод для получения статуса выполнения задачи.

## Метод для загрузки подразделений

`POST /account/{account_id}/all_divisions`

Метод принимает в теле запроса JSON со структурой подразделений.

JSON должен иметь следующий вид:

```json
{
    "items": [
        {
            "name": "название подразделения",
            "foreign": "уникальный ключ подразделения",
            "meta": { ... структура с дополнительной информацией> },
            "items": [ ... список дочерних подразделений> ]
        },
        ...
    ]
}
```

Путь | Тип | Обязательный | Описание
---- | -------- | ------------ | --------
name | string | Да | Название подразделения
foreign | string | Да | Уникальный идентификатор подразделения (как правило, это идентификатор подразделения во внутренней системе клиента)
meta | object | Нет | Произвольная структура с дополнительной информацией
items | array | Нет | Cписок с дочерними подразделениями


### Ограничения 

 * `foreign` и `name` строки с ненулевой длиной. 
 * Максимальная вложенность подразделений - 5. 
 * `foreign` должны быть уникальными во всей передаваемой структуре данных. 
 Если какое-то из этих условий нарушено, то сервер вернет ошибку валидации с HTTP статусом 400 (Bad request).
 * нельзя создавать задания на обновление иерархии подразделений чаще одного раза в 20 минут (для одного и того 
 же акаунта). Если будет произведена попытка обновления подразделений до 
 истечения 20 минут с момента последнего успешного запроса, то сервер вернет ошибку с HTTP статусом 429.

Вызов метода создает фоновую задачу на обновление структуры подразделений и
возвращает ее идентификатор.

### Пример запроса

```
POST /account/3/all_divisions

{
    "items": [
        {
            "name": "Подразделение 1",
            "foreign": "d1",
            "meta": {
                "country": "RU",
                "comment": "some text"
            },
            "items": [
                {
                    "name": "Подразделение 1.1",
                    "foreign": "d1.1",
                    "meta": {
                        "country": "RU",
                        "comment": "some text"
                    }
                },
                {
                    "name": "Подразделение 1.2",
                    "foreign": "d1.2",
                    "meta": {
                        "country": "RU",
                        "comment": "some text"
                    }
                }
            ]
        },
        {
            "name": "Подразделение 2",
            "foreign": "d2",
            "meta": {
                "country": "RU",
                "comment": "some text"
            }
        }
    ]
}
```

### Пример ответа

```json
{
    "status": "ok",
    "meta": {
        "account_id": 3,
        "data": {
            "items": [
                {
                    "name": "Подразделение 1",
                    "foreign": "d1",
                    "meta": {
                        "country": "RU",
                        "comment": "some text"
                    },
                    "items": [
                        {
                            "name": "Подразделение 1.1",
                            "foreign": "d1.1",
                            "meta": {
                                "country": "RU",
                                "comment": "some text"
                            }
                        },
                        {
                            "name": "Подразделение 1.2",
                            "foreign": "d1.2",
                            "meta": {
                                "country": "RU",
                                "comment": "some text"
                            }
                        }
                    ]
                },
                {
                    "name": "Подразделение 2",
                    "foreign": "d2",
                    "meta": {
                        "country": "RU",
                        "comment": "some text"
                    }
                }
            ]
        }
    },
    "payload": {
      "task_id": "b5174006-b46f-49fd-a16b-6fc0baf69d5f"
    }
}
```

Если задание на обновление подразделений принято, то в ответе вернется
`payload.task_id` – уникальный идентификатор задачи.

## Проверка статуса выполнения задачи обновления подразделений

`GET /account/{account_id}/delayed_task/{task_id}`

Идентификатор задачи (`task_id`) – идентификатор в поле `payload.task_id` в ответе на запрос обновления подразделений.

### Пример запроса

`GET /account/3/delayed_task/b5174006-b46f-49fd-a16b-6fc0baf69d5f`

### Пример ответа

```json
{
    "states_log": [
        {
            "state": "enqueued",
            "comment": null,
            "datetime": "2019-06-20T04:55:01+00:00",
            "timestamp": 1561006501.3160393
        },
        {
            "state": "inprogress",
            "comment": null,
            "datetime": "2019-06-20T04:55:01+00:00",
            "timestamp": 1561006501.318867
        },
        {
            "state": "success",
            "comment": null,
            "datetime": "2019-06-20T04:55:01+00:00",
            "timestamp": 1561006501.391373
        }
    ],
    "state": "success",
    "task_id": "11271792-f244-47c4-95a3-3e5973e7ffdc",
    "updated_datetime": "2019-06-20T04:55:01+00:00",
    "created": 1561006501.3160393,
    "created_datetime": "2019-06-20T04:55:01+00:00",
    "updated": 1561006501.391373
}
```


Путь | Тип | Описание
---- | -------- | --------
state | string | Текущий статус задачи (`enqueued`/`inprogress`/`success`/`failed`) 
created | unixtimestamp | Unix timestamp создания задачи
updated | unixtimestamp | Unix timestamp последнего обновления задачи
created_datetime | datetime | Дата и время (в ISO8601) создания задачи
updated_datetime | datetime | Дата и время (в ISO8601) последнего обновления задачи
states_log | array | Лог изменений по задаче
