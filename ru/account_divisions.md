# Описание API загрузки подразделений

API загрузки подразеделений предназначено для обновления иерархии
подразеделений.
Включает два метода: загрузка новой иерархии подразделений и метод для получения
статуса выполнения задачи.

## Метод для загрузки подразделений

Метод принимает в теле POST запроса JSON со структурой подразделений.
Структура подразделений должна иметь следующий вид:

```json
{
    "items": [
        {
            "name": "название подразделения",
            "foreign": "уникальный ключ подразделения",
            "meta": <структура с дополнительной информацией>,
            "items": <список дочерних подразделений>
        },
        ...
    ]
}
```

* name строка с названием подразделения (обязательное поле)
* foreign строка с уникальным идентификатором подразделения (обязательное поле).
  Идентификатор подразделения нужен чтобы отличать уже существующие в базе HF
  подразделения от новых, он позволяет узнать какие подразделения
  были удалены/обновлены/добавлены.
* meta произвольная структура с дополнительной информацией (необязательное поле)
* items список с дочерними подразделениями (необязательное поле)


Метод доступен по пути `/account/<идентификатор акаунта>/all_divisions`

Ограничения: `foreign`, `name` строки с ненулевой длиной. Максимальная
вложенность подразделений - 5. `foreign` должны быть уникальными во всей
передаваемой структуре данных. Если какое-то из этих условий нарушено, то сервер
вернет ошибку валидации с http статусом 400 (bad request).

*Ограничение на частоту обновления подразделений*: нельзя создавать задания на
обновление иерархии подразделений чаще одного раза в 20 минут (для одного и того
же акаунта). Если будет произведена попытка обновления подразделений до
истечения 20 минут с момента последнего успешного запроса, то сервер вернет
ошибку с http статусом 429.

Вызов метода создает фоновую задачу на обновление структуры подразделений и
возвращает ее идентификатор.

```
POST /account/3/all_divisions

{
    "items": [
        {
            "name": "Подразделение 1",
            "foreign": "d1",
            "meta": {
                "country": "RU",
                "comment": "some text"
            },
            "items": [
                "name": "Подразделение 1.1",
                "foreign": "d1.1",
                "meta": {
                    "country": "RU",
                    "comment": "some text"
                },
                "name": "Подразделение 1.2",
                "foreign": "d1.2",
                "meta": {
                    "country": "RU",
                    "comment": "some text"
                }
            ]
        },
        {
            "name": "Подразделение 2",
            "foreign": "d2",
            "meta": {
                "country": "RU",
                "comment": "some text"
            },
        },
    ]
}
```
Ответ 200:
```json
{
    "status": "ok",
    "meta": {
        "account_id": 3,
        "data": {
            "items": [
                {
                    "name": "Подразделение 1",
                    "foreign": "d1",
                    "meta": {
                        "country": "RU",
                        "comment": "some text"
                    },
                    "items": [
                        "name": "Подразделение 1.1",
                        "foreign": "d1.1",
                        "meta": {
                            "country": "RU",
                            "comment": "some text"
                        },
                        "name": "Подразделение 1.2",
                        "foreign": "d1.2",
                        "meta": {
                            "country": "RU",
                            "comment": "some text"
                        }
                    ]
                },
                {
                    "name": "Подразделение 2",
                    "foreign": "d2",
                    "meta": {
                        "country": "RU",
                        "comment": "some text"
                    },
                },
            ]
        }
    },
    "payload": {"task_id": "b5174006-b46f-49fd-a16b-6fc0baf69d5f"}
}
```

Если задание на обновление подразделений принято, то в ответе вернется
`payload.task_id` - уникальный идентификатор задачи.

## Проверка статуса выполнения задачи обновления подразделений

```
GET /account/<идентификатор акаунта>/delayed_task/<идентификатор задачи>
```
Где идентификатор задачи - идентификатор полученный в поле `payload.task_id`
в ответе на запрос обновления подразделений.

Пример запроса:
```
GET /account/3/delayed_task/b5174006-b46f-49fd-a16b-6fc0baf69d5f
```

Пример ответа:

```json
{
    "created": 1560488235.9336956,
    "updated": 1560488236.015671,
    "states_log": [
        {
            "comment": null,
            "timestamp": 1560488235.9336956,
            "state": "enqueued"
        },
        {
            "comment": null,
            "timestamp": 1560488235.936202,
            "state": "inprogress"
        },
        {
            "comment": null,
            "timestamp": 1560488236.015671,
            "state": "success"
        }
    ],
    "state": "success",
    "task_id": "b5174006-b46f-49fd-a16b-6fc0baf69d5f"
}
```
* `state` - текущий статус задачи (`enqueued`/`inprogress`/`success`/`failed`)
* `created`/`updated` - unix timestamp создания и последнего обновления статуса
  задачи
* `states_log` - лог изменения статусов задачи
